window.FS_Wallet=(function(){const s={provider:null,signer:null,address:null};const BSC='0x38';async function connect(){if(!window.ethereum)throw new Error('MetaMask not found');s.provider=new ethers.providers.Web3Provider(window.ethereum);await s.provider.send('eth_requestAccounts',[]);const net=await s.provider.getNetwork();if('0x'+net.chainId.toString(16)!==BSC){try{await window.ethereum.request({method:'wallet_addEthereumChain',params:[{chainId:BSC,chainName:'BNB Smart Chain',nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18},rpcUrls:['https://bsc-dataseed.binance.org']}]});}catch(e){}}s.signer=s.provider.getSigner();s.address=(await s.signer.getAddress()).toLowerCase();await fetch('/api/set_wallet.php',{method:'POST',body:new URLSearchParams({address:s.address})});render();return s;}function disconnect(){s.provider=s.signer=null;s.address=null;fetch('/api/set_wallet.php',{method:'POST',body:new URLSearchParams({address:''})});render();}function render(){const el=document.getElementById('walletTop');if(!el)return;if(!s.address){el.innerHTML='<button id=\"btnConnect\" class=\"btn\">Connect Wallet</button>';el.querySelector('#btnConnect').onclick=()=>connect().catch(e=>alert(e.message));}else{el.innerHTML=`<div class="wallet-card"><div>${s.address.slice(0,6)}...${s.address.slice(-4)}</div><button id="btnDisconnect" class="btn btn-outline">Disconnect</button></div>`;document.getElementById('btnDisconnect').onclick=()=>disconnect();}}async function signDownloadMessage({domain,license,productId}){if(!s.signer)await connect();const ts=Math.floor(Date.now()/1000);const nonce=(Math.random().toString(16).slice(2)+Math.random().toString(16).slice(2)).slice(0,16);const msg=`FinalSpace Download Confirmation\nDomain: ${domain}\nLicense: ${license}\nProduct: ${productId}\nTime: ${ts}\nNonce: ${nonce}`;const sig=await s.signer.signMessage(msg);const pub=ethers.utils.recoverPublicKey(ethers.utils.hashMessage(msg),sig);return {message:msg,signature_hex:sig,public_key:pub};}document.addEventListener('DOMContentLoaded',render);return {connect,disconnect,state:s,signDownloadMessage};})();